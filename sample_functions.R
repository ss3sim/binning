#' Sample conditional age-at-length compositions from expected values
#'
#' Take a \code{data.SS_new} file containing expected values and sample to
#' create observed length-at-age compositions which are then written to
#' file for use by the estimation model.
#'
#' @author Cole Monnahan
#'
#' @template lcomp-agecomp-index
#' @template lcomp-agecomp
#' @param agebin_vector Depreciated argument. Does nothing and will be
#'   removed in a future major version update. Instead, see
#'   \code{change_bin}.
#' @param cv A vector of coefficient of variation to use for each fleet.
#'
#' @template sampling-return
#' @template casefile-footnote
#' @seealso \code{\link{sample_lcomp}, \link{sample_agecomp}}
#' @export

infile <- "wtatage.ss_new"
outfile <- "wtatage_test.dat"
sample_wtatage <- function(infile, outfile, fleets = 1, Nsamp,
                           years, cv, write_file=TRUE){
    ## Read in the file and grab the expected values
    infile <- readLines(infile)
    ## Remove double spaces, which SS3 writes in the 7th column
    infile <- gsub("  ", replace=" ", x=infile)
    xx <- grep(x=infile, "#yr seas gender growpattern birthseas fleet")
    if(length(xx)!=1) stop("Failed to read in wtatage file")
    header <- unlist(strsplit(infile[xx], " "))
    wtatage <- infile[(xx+1):length(infile)]
    wtatage <-  as.data.frame(matrix(as.numeric(unlist(strsplit(wtatage, split=" "))),
                       nrow=length(wtatage), byrow=TRUE))
    names(wtatage) <- gsub("#", replace="", x=header)
    ## Check inputs for errors
    if(substr_r(outfile,4) != ".dat" & write_file)
        stop(paste0("outfile ", outfile, " needs to end in .dat"))
    Nfleets <- ifelse(is.null(fleets), 0, length(fleets))
    unique(wtatage$yr)
    ## End input checks

    ## Resample from the length-at-age data
    ## The general approach here is to loop through each row to keep
    ## (depends on years input) and resample depending on Nsamp and
    ## cvar. All these rows are then combined back together to form
    ## the final ccomp.
    newcomp.list <- list() # temp storage for the new rows
    k <- 1                 # each k is a new row of data, to be rbind'ed later
    ## Loop through each fleet, if fleets=NULL then skip sampling and
    ## return nothing (subtract out this type from the data file)
    if (Nfleets>0){
        for(i in 1:length(fleets)){
            fl <- fleets[i]
            agecomp.fl <- agecomp.cal[agecomp.cal$FltSvy == fl &
                                      agecomp.cal$Yr %in% years[[i]], ]
            if(length(years[[i]]) != length(unique((agecomp.fl$Yr))))
                stop(paste("A year specified in years was not found in the",
                           "input file for fleet", fl))
            agecomp.fl$Nsamp <- Nsamp[[i]]
            ## Only loop through the subset of years for this fleet
            for(yr in years[[i]]) {
                newcomp <- agecomp.fl[agecomp.fl$Yr==yr, ]
                ## Now loop through each row and sample for each age bin
                ## (column)
                for(j in 1:NROW(newcomp)){
                    newcomp.lbin <- newcomp[j,]
                    ## Replace expected values with sampled values
                    ## First 1-9 cols aren't data so skip them
                    means <- as.numeric(newcomp.lbin[-(1:9)])
                    sds <- means*cv[[i]]
                    ## These are the moments on the natural scale, so
                    ## convert to log scale and generate data
                    means.log <- log(means^2/sqrt(sds^2+means^2))
                    sds.log <- sqrt(log(1 + sds^2/means^2))
                    x <- exp(rnorm(1e6, mu, sdd))
                    samples.list <- lapply(1:length(means), function(kk)
                        exp(rnorm(n=newcomp.lbin$Nsamp, mean=means.log[kk], sd=sds.log[kk])))
                    ## Take means and combine into vector to put back
                    ## into the data frame
                    newcomp.lbin[-(1:9)] <- do.call(c, lapply(samples.list, mean))
                    newcomp.list[[k]] <- newcomp.lbin
                    k <- k+1
                }
            }
        }
    }

    ## Combine new rows together into one data.frame
    if(Nfleets>0){
        newcomp.final <- do.call(rbind, newcomp.list)
        ## Recombine the age data, since we don't want to lose that
        newcomp.final <- rbind(agecomp.age, newcomp.final)
    } else {  ## else was NULL so strip out the length-at-age data
        newcomp.final = agecomp.age
    }
    ## Make changes to the dat file
    infile$N_agecomp <- nrow(newcomp.final)
    infile$agecomp <- newcomp.final

    ## Write the modified file
    if(write_file)
        r4ss::SS_writedat(datlist = infile, outfile = outfile,
                          overwrite = TRUE, verbose=FALSE)
    return(invisible(newcomp.final))
}
